function textClass(a){this.wordsLen=1;this.currWordIndex=1;this.id=a;this.readPara=function(){var b=this.id;this.resetText();this.wordsLen=$("#"+b+" span").length;this.highlightWord(this.currWordIndex)};this.highlightWord=function(e){var b=this.id;$("#"+b+" span.green").removeClass("green");$("#"+b+" span:nth-child("+(parseInt(e))+")").addClass("green")};this.getWord=function(b){var e=$("#"+this.id+" span:nth-child("+(parseInt(b))+")").text();return e};this.nextWord=function(){if(this.currWordIndex<this.wordsLen){this.currWordIndex++;this.highlightWord(this.currWordIndex);return true}else{return false}};this.paraOver=function(){return(this.currWordIndex>=this.wordsLen)};this.resetText=function(){this.currWordIndex=1;$("#"+this.id+" span.green").removeClass("green");$("#"+this.id+" span.red").removeClass("red")};this.indicateWrong=function(b){b=typeof b!=="undefined"?b:false;if(b){$("#"+this.id+" span.green").addClass("red")}else{$("#"+this.id+" span.green").removeClass("red")}};this.getProgress=function(){return parseInt((this.currWordIndex-1)/this.wordsLen*100)}}function timerClass(){this.timer=null;this.timerVal=0;this.callBack;this.limit=1000;this.scopeObj;this.startTimer=function(f,a,h){var g=this;g.timerVal=0;g.limit=parseInt(h,10)||10000;g.callBack=a;g.scopeObj=f;g.timer=window.setInterval(function(){g.incrementTimer()},100)};this.endTimer=function(){clearInterval(this.timer)};this.incrementTimer=function(){var a=this;a.timerVal++;if(a.timerVal>=a.limit){a.endTimer()}a.callBack.call(a.scopeObj,a.timerVal)}}function gameClass(a,m,n,k,i,j){this.timeElapsed=0;this.timerObj=new timerClass();this.textObj=new textClass(a);this.input_id=m;this.msg_id=n;this.button=k;this.trackid=i;this.status="off";this.no_submit=j||false;this.top_margin=0;this.countdown_limit=parseInt(configObj.countdown_limit,10)*10;this.initGame=function(){_gtrack("game","start");this.timerObj.startTimer(this,this.countDownCallBack,this.countdown_limit)};this.countDownCallBack=function(c){var b=this.countdown_limit-c;if(b==0){$("#countdownlayerbg, #countdownlayer").addClass("hid");this.startGame()}else{$("#countdownlayerbg, #countdownlayer").removeClass("hid");$("#countdownlayer").text(parseInt(b/10,10)+1)}};this.startGame=function(){var b=this;b.textObj.readPara();b.timerObj.startTimer(b,b.timerCallBack);$("#"+b.input_id).removeAttr("disabled").val("").focus();if($("#"+b.button).length>0){$("#"+b.button).text("stop!")}b.handlePositioning();b.handleProgress();b.timeElapsed=0;b.status="on"};this.showMessage=function(b,c){if(b===true){$("#"+this.msg_id).show();if(c){$("#"+this.msg_id).html(c)}}else{if(b===false){$("#"+this.msg_id).hide()}}};this.showTimeInMessage=function(b){if(typeof b=="undefined"){b=this.timeElapsed/10}this.showMessage(true,String(b))};this.timerCallBack=function(b){this.timeElapsed=b;this.showTimeInMessage()};this.handleChange=function(b){var c=this.textObj.getWord(this.textObj.currWordIndex);var d=$("#"+this.input_id).val();d=d.trim();if(this.textObj.paraOver()&&d==c){this.endGame();return}if(d!=c.substr(0,d.length)){this.textObj.indicateWrong(true)}else{this.textObj.indicateWrong(false)}if(typeof b!="undefined"&&(b==13||b==32)){if(d==c){$("#"+this.input_id).val("");this.textObj.nextWord();this.handlePositioning();this.handleProgress()}}};this.handlePositioning=function(){var b,d,c;if($("#"+this.trackid).find("span.green").length>0){b=$("#"+this.trackid).find("span.green").position().top;d=$("#"+this.trackid).height()-b}if(b&&b>100&&d>50){c=parseInt(b-100);if(c!=this.top_margin){$("#"+this.trackid).animate({"margin-top":"-"+c+"px"},500);this.top_margin=c}}else{c=Math.abs(this.top_margin);if(typeof b!="undefined"&&b<100&&c!=0){$("#"+this.trackid).animate({"margin-top":"0px"});this.top_margin=0;c=0}}if(c+200<$("#"+this.trackid).height()){$("#"+this.trackid+"bs").show()}else{$("#"+this.trackid+"bs").hide()}if(c>0){$("#"+this.trackid+"ts").show()}else{$("#"+this.trackid+"ts").hide()}};var l=this;if($("#"+this.button).length>0){$("#"+this.button).text("start");$("#"+this.button).bind("click",function(){if(l.status=="off"){if(!l.no_submit&&document.cookie.indexOf("tr_username")==-1){userObj.askUsername()}l.initGame()}else{l.endGame(true)}})}$("#"+this.input_id).val("").attr("disabled","disabled");$("#"+this.input_id).bind("keyup keypress",function(b){var c=b.which||b.charCode;l.handleChange(c)})}gameClass.prototype.handleProgress=function(){var a;if(typeof complete!="undefined"&&complete){a=100}else{a=this.textObj.getProgress()}$("#"+this.trackid+"progress").css("width",a+"%")};gameClass.prototype.endGame=function(a){var c=(typeof a!=="undefined")?a:false;this.showTimeInMessage();this.textObj.resetText();$("#"+this.input_id).val("").attr("disabled","disabled");if($("#"+this.button).length>0){$("#"+this.button).text("start!")}this.timerObj.endTimer();if(!c&&!this.no_submit){ajaxObj.submitScore(this.timeElapsed);_gtrack("game","complete")}this.handleProgress(true);this.status="off";_gtrack("game","end")};var userObj=new function(){this.askUsername=function(){var c,b=$("#username"),a=b.text();if(c=prompt("Want to choose a username?",b.text())){b.text(c)}setCookie("tr_username",b.text());if(a!=c){_gtrack("username","change")}}};var layerObj=new function(){this.show=function(a,g){this.closeAll();var h=$("#"+g).position();var j=$("#"+g).width();var i=$('<div id="layerObj" class="box-shadow"></div>').html(a).appendTo("body").css("left",h.left+j).css("top",h.top)};this.closeAll=function(){$("#layerObj").remove()}};var ajaxObj=new function(){this.submitScore=function(a){if(!a){return false}var b=$("#username").text();if(!b){alert("You ain't got no name?");return false}$("#messageDiv").show().text("submitting score");$.post(configObj.backendUrl+"/submitScore",{blah:a,name:b},function(c){var d=JSON.parse(c);if(!d.s){alert("something went wrong!");gameObj.showMessage("",false)}else{ajaxObj.updateScoreTable()}$("#messageDiv").hide().text("")});return false};this.updateScoreTable=function(){$("#messageDiv").text("updating score table..");$.get(configObj.backendUrl+"/fetchScore",function(b){var a=JSON.parse(b);if(a.status==1){$("#scoreTable").html(a.content)}else{$("#scoreTable").html(a.content)}$("#messageDiv").text("")})};this.longPollRoom=function(){$.get(configObj.backendUrl+"/roomPing",{room_id:roomData.room_id,mod:roomData.mod},function(b){var a=JSON.parse(b);if(a.s){if(a.d){roomData.mod=a.mod;roomData.players=a.info;room_showPlayers();room_updateStatus(true)}ajaxObj.longPollRoom()}else{room_updateStatus(false)}}).fail(function(){room_updateStatus(false)})};this.markReady=function(){$.get(configObj.backendUrl+"/markReady",{room_id:roomData.room_id},function(b){var a=JSON.parse(b);if(!a.s){room_updateStatus(false)}}).fail(function(){room_updateStatus(false)})};this.updateProgress=function(a,d){$.post(configObj.backendUrl+"/updateProgress",{progress:roomData.p,time:roomObj.timeElapsed,room_id:roomData.room_id},function(c){var b=JSON.parse(c);if(!b.s){room_updateStatus(false)}}).fail(function(){room_updateStatus(false)})}};function setCookie(a,h,j){var g=new Date();g.setDate(g.getDate()+j);var i=escape(h)+((j==null)?"":"; expires="+g.toUTCString());document.cookie=a+"="+i}function _gtrack(a,b){if(typeof ga=="function"){ga("send","event",a,b)}}var gameObj;$(function(){$("#username").bind("click",function(){userObj.askUsername()});$(".trackDiv").bind("click",function(){window.location=configObj.baseUrl+"?trackid="+$(this).attr("trackid")});if($("#track").length>0){gameObj=new gameClass("para","typeValue","timeDiv","gameHandle","para");ajaxObj.updateScoreTable()}});